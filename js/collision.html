<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="d3.v3.min.js"></script>
<script src="jamendo-data.js"></script>
<style>
.overlay {
  fill: none;
  pointer-events: all;
}
</style>
</head>

<body>

<div id="audio"></div>
<div id="body">
<script type="text/javascript">

var songs = JSON.parse(songs);
var RADIUS = 20
var color = d3.scale.category10();

var w = window,
    e = document.documentElement,
    g = document.getElementsByTagName('body')[0]

var width = w.innerWidth || e.clientWidth || g.clientWidth;
var height = w.innerHeight|| e.clientHeight|| g.clientHeight;


//##### NODES #####

var numOfSongs = Object.keys(songs.songs).length
var nodes = d3.range(numOfSongs).map(function() { return {radius: RADIUS}; })
	
nodes.forEach(function(d, i) { 
	var keys = Object.keys(songs.songs)
	var songIndex = keys[i]
	d.id = songIndex.slice(1)

	var tempo = songs.songs[songIndex].tempo
	d.fociX = getFociX(tempo)
	d.x = d.fociX

	var key = songs.songs[songIndex].key
	d.fociY = getFociY(key)
	d.y = d.fociY
})

function getFociX(tempo) {
	if (tempo == 0) {
		tempo = Math.random()
	}
	var logOfTempo = Math.floor( Math.log(tempo) / Math.log(2));
	var tempoFloor = Math.pow(2, logOfTempo)
	var widthRatio = (tempo - tempoFloor) / tempoFloor
	return width * widthRatio
}

function getFociY(key) {
	var positions = [11, 4, 9, 2, 7, 12, 5, 10, 3, 8, 1, 6]
	var pos = positions[key]
	var heightRatio = pos / 12	
	return height * heightRatio
}


//##### SVG #####

var svg = d3.select("#body").append("svg:svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoomHandler))
  .append("g");

svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height);

var node = svg.selectAll("g")
	.data(nodes)
  .enter().append("g")

var clipPath = node.append("clipPath")
	.attr("id", "cut-off-bottom")

clipPath.append("circle")
    .attr("cx", function(d) { return d.radius - 2; })
    .attr("cy", function(d) { return d.radius - 2; })
    .attr("r", function(d) { return d.radius - 2; })

node.append("image")
	.attr("x", "0")
	.attr("y", "0")
	.attr("xlink:href", function(d) { return "../JamendoDataset/"+ d.id + ".jpg" })
    .attr("height", function(d) { return (d.radius-2) * 2; })
    .attr("width", function(d) { return (d.radius-2) * 2; })
	.attr("clip-path", "url(#cut-off-bottom)")
	.on("click", function(d) { play(d.id) })

function zoomHandler() {
	svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}


//##### ON TICK #####

var force = d3.layout.force()
    .gravity(0)
    .nodes(nodes)
    .size([width, height])
	.links([])

force.start();

force.on("tick", function(e) {
	var k = .1 * e.alpha;
    nodes.forEach(function(o, i) {
		o.y += (o.fociY - o.y) * k;
		o.x += (o.fociX - o.x) * k;
	});

   var q = d3.geom.quadtree(nodes)
   nodes.forEach(function(o) { q.visit(collide(o)) })

   svg.selectAll("g")
  		.attr("transform", function(d) { return "translate(" +d.x+ "," +d.y+")" });
});

function collide(node) {
  var r = node.radius + 16,
      nx1 = node.x - r,
      nx2 = node.x + r,
      ny1 = node.y - r,
      ny2 = node.y + r;
  return function(quad, x1, y1, x2, y2) {
    if (quad.point && (quad.point !== node)) {
      var x = node.x - quad.point.x,
          y = node.y - quad.point.y,
          l = Math.sqrt(x * x + y * y),
          r = node.radius + quad.point.radius;
      if (l < r) {
        l = (l - r) / l * .5;
        node.x -= x *= l;
        node.y -= y *= l;
        quad.point.x += x;
        quad.point.y += y;
      }
    }
    return x1 > nx2
        || x2 < nx1
        || y1 > ny2
        || y2 < ny1;
  };
}


//##### AUDIO #####

generateAudioElements()

var playingAudio=""

function generateAudioElements() {
	var audioDiv = document.getElementById("audio")
	for (var id in songs.songs) {
		id = id.slice(1)
		var audioElement = document.createElement("audio")
		audioElement.setAttribute("id", "audio"+id);
		audioElement.setAttribute("src", "../JamendoDataset/"+id+".mp3");
		audioDiv.appendChild(audioElement)
	}
}

function play(audioFileId){
   var audio = document.getElementById("audio"+audioFileId);
   if (audio.paused) {
	   if (playingAudio != "") {
			playingAudio.pause();
			playingAudio.currentTime = 0;
	   }
	   audio.play();
	   playingAudio=audio;
   } else {
	   audio.pause();
	   audio.currentTime = 0;
   }
}

</script>
</body></html>
