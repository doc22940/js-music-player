<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="d3.v3.min.js"></script>
<script src="jamendo-data.js"></script>
<style>
.overlay {
  fill: none;
  pointer-events: all;
}
</style>
</head>

<body>

<div id="audio"></div>
<div id="body">


<script type="text/javascript">

var RADIUS = 20
var TRANSITION_DURATION = 500

var songs = JSON.parse(songs);
var color = d3.scale.category10();

var w = window,
    e = document.documentElement,
    g = document.getElementsByTagName('body')[0]

var width = w.innerWidth || e.clientWidth || g.clientWidth;
var height = w.innerHeight|| e.clientHeight|| g.clientHeight;


//##### NODES #####

var numOfSongs = Object.keys(songs.songs).length
var nodes = d3.range(numOfSongs*2).map(function() { return {r: RADIUS}; })
	
nodes.forEach(function(d, i) { 
	var keys = Object.keys(songs.songs)
	var songIndex = keys[i%numOfSongs]
	
	// SET id
	d.id = songIndex.slice(1)

	// SET X
	var tempo = songs.songs[songIndex].tempo
	d.fociX = getFociX(tempo)
	d.x = d.fociX

	// SET Y
	var key = songs.songs[songIndex].key
	// TODO make TORUS spacd
	if ((i/numOfSongs) < 1) {
		d.fociY = getFociY(key);
	} else {
		d.fociY = getFociY(key) + height;
	}
	d.y = d.fociY

	// SET R
	d.fociR = d.r
})

function getFociX(tempo) {
	if (tempo == 0) {
		tempo = Math.random()
	}
	var logOfTempo = Math.floor( Math.log(tempo) / Math.log(2));
	var tempoFloor = Math.pow(2, logOfTempo)
	var widthRatio = (tempo - tempoFloor) / tempoFloor
	return width * widthRatio
}

function getFociY(key) {
	var positions = [11, 4, 9, 2, 7, 12, 5, 10, 3, 8, 1, 6]
	var pos = positions[key]
	var heightRatio = pos / 12	
	return height * heightRatio
}


//##### SVG #####

// TODO enlarge canvas
var svg = d3.select("#body").append("svg:svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .call(d3.behavior.zoom().scaleExtent([1, 8]).on("zoom", zoomHandler))
  .append("g");

// TODO enlarge canvas
svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height);

// Utility function for drawing play triangle on icon
var lineData = [ { "x": 1, "y": 5}, { "x": 20, "y": 20},
					{ "x": 1, "y": 20}, { "x": 1, "y": 10 }];

var lineFunction = d3.svg.line()
	.x(function(d) { return d.x; })
	.y(function(d) { return d.y; })
	.interpolate("linear");


//##### SVG NODE #####

// TODO tie triangle to playing function
var node = svg.selectAll("g")
	.data(nodes)
  	.enter().append("g")
	.on("click", function(d) { play(d) })
	.attr('id', function(d) { return 'name' + d.id })

var clipPath = node.append("clipPath")
	.attr("id", "cut-off-bottom")

clipPath.append("circle")
    .attr("cx", function(d) { return d.r; })
    .attr("cy", function(d) { return d.r; })
    .attr("r", function(d) { return d.r; })

node.append("image")
	.attr("x", "0")
	.attr("y", "0")
	.attr("xlink:href", function(d) { return "../JamendoDataset/"+ d.id + ".jpg" })
    .attr("height", function(d) { return (d.r) * 2; })
    .attr("width", function(d) { return (d.r) * 2; })
	.attr("clip-path", "url(#cut-off-bottom)")

function zoomHandler() {
	svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

function refreshNode(n) {
	n.select("clipPath")
	.attr("id", "cut-off-bottom")
	.select("circle")
    .attr("cx", function(d) { return d.r; })
    .attr("cy", function(d) { return d.r; })
    .attr("r", function(d) { return d.r; })

	n.select("image")
	.attr("x", "0")
	.attr("y", "0")
    .attr("height", function(d) { return (d.r) * 2; })
    .attr("width", function(d) { return (d.r) * 2; })
	.attr("clip-path", "url(#cut-off-bottom)")
}

function addPlayIcon(g) {
	g.append("path")
		.attr("d", lineFunction(lineData))
   		.attr("fill-opacity","0.6")
		.attr("fill", "true")
}

function removePlayIcon(g) {
	g.select("path").remove()
}

function enlargePlayIcon(g) {
/*
	var icon = g.select("path")
	var d = icon.select("d")
	g
		.transition()
    	.duration(TRANSITION_DURATION)
		.attr("transform", "translate(-"+RADIUS+",-"+RADIUS+")scale(2.0)")
*/
}

function shrinkPlayIcon(g) {

}

function enlargeNode(g) {
/*
	g
			.transition()
			.duration(TRANSITION_DURATION)
			//.attr("transform", "translate(-"+RADIUS+",-"+RADIUS+")scale(2.0)")
			.attr("transform", "scale(2.0)")
*/

	// TEST
/*
	console.log("nodes length is "+nodes.length)
	nodes.forEach(function(n) {
		console.log("n.r is "+n.r)
		n.r = 88
	})
*/
	// TEST

	// ONLY IMAGE
	//var image = g.select("image")
	//enlargeImage(image)


	nodes.forEach(function(d) {
		var gId = g.attr("id").slice(4)
		if (d.id == gId) {
			d.fociR = RADIUS * 2
		}
	})

	//refreshNode(g)

	force.start();
}

function shrinkNode(g) {
/*
	g
			.transition()
			.duration(TRANSITION_DURATION)
			.attr("transform", "scale(1.0)")
*/
	//var image = g.select("image")
	//shrinkImage(image)


	nodes.forEach(function(d) {
		var gId = g.attr("id").slice(4)
		if (d.id == gId) {
			d.fociR = RADIUS
		}
	})

	//refreshNode(g)

	force.start();
}

function enlargeImage(image) {
	image
		.transition()
    	.duration(TRANSITION_DURATION)
		.attr("transform", "translate(-"+RADIUS+",-"+RADIUS+")scale(2.0)")
}

function shrinkImage(image) {
	image
		.transition()
    	.duration(TRANSITION_DURATION)
		.attr("transform", "scale(1.0)")
}

//##### ON TICK #####

var force = d3.layout.force()
    .gravity(0)
    .nodes(nodes)
    .size([width, height])
	.links([])

force.start();

force.on("tick", function(e) {
	var k = .1 * e.alpha;
    nodes.forEach(function(o) {
		o.y += (o.fociY - o.y) * k
		o.x += (o.fociX - o.x) * k
		if (o.r < o.fociR) {
			o.r++
			var g = d3.select( '#name' + o.id)
//			g
//				.attr("transform", "scale("+o.r/RADIUS+")")

//			g
//					.transition()
//					.duration(TRANSITION_DURATION)
					//.attr("transform", "translate(-"+RADIUS+",-"+RADIUS+")scale(2.0)")
//					.attr("transform", "scale(2.0)")


			//refreshNode(g)
		} else if (o.r > o.fociR) {
			o.r--
			// select the right node (from node (or g)) and transform it
			var g = d3.select( '#name' + o.id)
			//refreshNode(g)
		}
	});

   var q = d3.geom.quadtree(nodes)
   nodes.forEach(function(o) { q.visit(collide(o)) })

	//// !!!!!!!!!!!!!!!!!!!!!
   svg.selectAll("g")
  		.attr("transform", function(d) { 
			var relativeSize = d.r/RADIUS
			var x = d.x - d.r
			var y = d.y - d.r
			return "translate("+x+","+y+")scale("+relativeSize+")" 
		});
});

function collide(node) {
  var r = node.r + 16,
      nx1 = node.x - r,
      nx2 = node.x + r,
      ny1 = node.y - r,
      ny2 = node.y + r;
  return function(quad, x1, y1, x2, y2) {
    if (quad.point && (quad.point !== node)) {
      var x = node.x - quad.point.x,
          y = node.y - quad.point.y,
          l = Math.sqrt(x * x + y * y),
          r = node.r + quad.point.r;
      if (l < r) {
        l = (l - r) / l * .5;
        node.x -= x *= l;
        node.y -= y *= l;
        quad.point.x += x;
        quad.point.y += y;
      }
    }
    return x1 > nx2
        || x2 < nx1
        || y1 > ny2
        || y2 < ny1;
  };
}


//##### AUDIO #####

generateAudioElements()

function generateAudioElements() {
	var audioDiv = document.getElementById("audio")
	for (var id in songs.songs) {
		var id = id.slice(1)
		var audioElement = document.createElement("audio")
		audioElement.setAttribute("id", "audio"+id);
		audioElement.setAttribute("src", "../JamendoDataset/"+id+".mp3");

		// ENDED
		audioElement.addEventListener('ended', function(e) {
			var g = d3.select( '#name' + this.id.slice(5))
			removePlayIcon(g)
			shrinkNode(g)
		}, false);

		// PLAY
		audioElement.addEventListener('play', function(e) {
			var g = d3.select( '#name' + this.id.slice(5))
			addPlayIcon(g)
			enlargeNode(g)			
		}, false);

		// PAUSE
		audioElement.addEventListener('pause', function(e) {
			var g = d3.select( '#name' + this.id.slice(5))
			removePlayIcon(g)
			shrinkNode(g)
		}, false);

		audioDiv.appendChild(audioElement)
	}
}

var playingAudio=""

function play(nodesData){
	var audioFileId = nodesData.id
	var node = d3.select( '#name' + audioFileId );	
   	var audio = document.getElementById("audio"+audioFileId);
   	if (audio.paused) {
		if (playingAudio != "") {
			playingAudio.pause();
			playingAudio.currentTime = 0;
		}
	   	audio.play();
	   	playingAudio=audio;
   	} else {
	   	audio.pause();
	   	audio.currentTime = 0;
   	}
}

</script>
</body></html>
